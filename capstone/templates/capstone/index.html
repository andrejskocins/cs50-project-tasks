{% extends "capstone/layout.html" %}

{% block script %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentSort = { column: null, ascending: true };
    
    function sortTable(column, index) {
        const taskList = document.querySelector('.task-list');
        const items = Array.from(document.querySelectorAll('.task-item'));
        
        // Toggle sort direction if clicking same column
        if (currentSort.column === column) {
            currentSort.ascending = !currentSort.ascending;
        } else {
            currentSort.column = column;
            currentSort.ascending = true;
        }
        
        // Sort the items
        items.sort((a, b) => {
            const aCell = a.children[index];
            const bCell = b.children[index];
            let aVal = aCell.dataset.sort ?? aCell.textContent.trim();
            let bVal = bCell.dataset.sort ?? bCell.textContent.trim();

            if (column === 'start_time' || column === 'due_date') {
                // Use ISO strings or epoch seconds if provided
                const aDate = isNaN(aVal) ? new Date(aVal).getTime() : Number(aVal);
                const bDate = isNaN(bVal) ? new Date(bVal).getTime() : Number(bVal);
                if (aDate < bDate) return currentSort.ascending ? -1 : 1;
                if (aDate > bDate) return currentSort.ascending ? 1 : -1;
                return 0;
            }

            // String comparison, case-insensitive
            aVal = aVal.toLowerCase();
            bVal = bVal.toLowerCase();
            if (aVal < bVal) return currentSort.ascending ? -1 : 1;
            if (aVal > bVal) return currentSort.ascending ? 1 : -1;
            return 0;
        });
        
        // Update the DOM
        items.forEach(item => taskList.appendChild(item));
        
        // Update arrows
        document.querySelectorAll('.sortable').forEach(el => {
            el.innerHTML = el.innerHTML.replace(/▲|▼/g, '').trim();
        });
        document.querySelector(`[data-column="${column}"]`).innerHTML += 
            currentSort.ascending ? ' ▲' : ' ▼';
    }
    
    document.querySelectorAll('.sortable').forEach(el => {
        el.addEventListener('click', function(e) {
            e.preventDefault();
            const column = this.dataset.column;
            const index = parseInt(this.dataset.index);
            sortTable(column, index);
        });
    });

    // Modal control moved to layout for global reuse

});
</script>
{% endblock %}

{% block body %}

<div class="page-content">
    <div class="task-controls">
        <div>
            <select name="category" id="category">
                <option value="all-tasks">All Tasks</option>
                <option value="">All Tasks</option>
            </select>
        </div>
        <div class="add-task-button">
            <button id="open-task-modal" data-open-task-modal class="btn btn-primary" type="button">Add Task</button>
        </div>
    </div>

    <div class="task-list">
    <div class="task-header flex-container">
        <div></div>
        <div class="sortable" data-column="title" data-index="1">TASK</div>
        <div class="sortable" data-column="author" data-index="2">AUTHOR</div>
        <div class="sortable" data-column="start_time" data-index="3">START DATE</div>
        <div class="sortable" data-column="due_date" data-index="4">DUE DATE</div>
    </div>
    {% for task in tasks %}
        <div class="task-item flex-container {% if task.completed %}completed{% endif %}">
            <div><input type="checkbox" class="task-checkbox" {% if task.completed %}checked{% endif %}></div>
            <div class="task-title">{{ task.title }}</div>
            <div class="task-author" data-sort="{{ task.author.username|lower }}">{{ task.author.username }}</div>
            <div class="task-start-date" data-sort="{{ task.start_time|date:'c' }}">{{ task.start_time|date:"Y-m-d H:i" }}</div>
            <div class="task-due-date" {% if task.due_date %}data-sort="{{ task.due_date|date:'c' }}"{% endif %}>
                {% if task.due_date %}{{ task.due_date|date:"Y-m-d" }}{% else %}&nbsp;{% endif %}
            </div>
        </div>
    {% empty %}
        <p>No tasks here.</p>
    {% endfor %}
    </div>
</div>

{% block modals %}{% endblock %}

{% endblock %}